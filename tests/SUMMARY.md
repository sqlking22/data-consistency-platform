# æ•°æ®ä¸€è‡´æ€§å¹³å° - æµ‹è¯•å¥—ä»¶æ€»ç»“æŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è§ˆ

**é¡¹ç›®åç§°**: è·¨åº“æ•°æ®ä¸€è‡´æ€§æ ¡éªŒä¸ä¿®å¤å¹³å°
**æµ‹è¯•æ¡†æ¶**: pytest + pytest-cov
**æµ‹è¯•ç±»å‹**: å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•
**åˆ›å»ºæ—¶é—´**: 2026-02-25

## ğŸ¯ æµ‹è¯•è¦†ç›–ç›®æ ‡

- âœ… **æ ¸å¿ƒé€»è¾‘è¦†ç›–ç‡**: ç›®æ ‡ 95%
- âœ… **æ€»ä½“è¦†ç›–ç‡**: ç›®æ ‡ 85%
- âœ… **æµ‹è¯•ç”¨ä¾‹æ•°**: 191ä¸ª
- âœ… **æ¨¡å—è¦†ç›–**: 100%æ ¸å¿ƒæ¨¡å—

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ conftest.py                  # å…¬å…±å¤¹å…·å’Œpytesté…ç½®
â”œâ”€â”€ test_config_manager.py       # é…ç½®ç®¡ç†å™¨æµ‹è¯• (21ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_db_adapter.py           # æ•°æ®åº“é€‚é…å™¨æµ‹è¯• (42ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_compare_engine.py       # æ¯”å¯¹å¼•æ“æµ‹è¯• (34ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_repair_engine.py        # ä¿®å¤å¼•æ“æµ‹è¯• (42ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_notification.py         # é€šçŸ¥æ¨¡å—æµ‹è¯• (17ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_main.py                 # ä¸»æµç¨‹æµ‹è¯• (21ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_utils.py                # å·¥å…·ç±»æµ‹è¯• (14ä¸ªæµ‹è¯•)
â”œâ”€â”€ README.md                    # æµ‹è¯•è¯´æ˜æ–‡æ¡£
â””â”€â”€ TEST_FIX_REPORT.md           # æµ‹è¯•é—®é¢˜ä¿®å¤æŒ‡å—
```

## âœ¨ æµ‹è¯•ç‰¹æ€§

### 1. å…¨é¢çš„é…ç½®ç®¡ç†æµ‹è¯•
- âœ… å¤šå±‚çº§é…ç½®ä¼˜å…ˆçº§ (å‘½ä»¤è¡Œ > settings.py > JSON > æ•°æ®åº“)
- âœ… é…ç½®åŠ è½½å’ŒéªŒè¯
- âœ… å¯†ç åŠ è§£å¯†
- âœ… å•ä»»åŠ¡å’Œå¤šä»»åŠ¡æ¨¡å¼

### 2. æ•°æ®åº“é€‚é…å™¨æµ‹è¯•
- âœ… MySQL/Oracle/PostgreSQL/SQLServeræ”¯æŒ
- âœ… è¿æ¥æ± ç®¡ç†
- âœ… æŸ¥è¯¢å’Œæ‰§è¡Œæ“ä½œ
- âœ… é‡è¯•æœºåˆ¶
- âœ… äº‹åŠ¡å¤„ç†

### 3. æ¯”å¯¹å¼•æ“æµ‹è¯•
- âœ… Pandaså¼•æ“ (å°æ•°æ®é‡ <50ä¸‡)
- âœ… Sparkå¼•æ“ (å¤§æ•°æ®é‡ >50ä¸‡)
- âœ… å¢é‡/å…¨é‡æ¯”å¯¹
- âœ… è‡ªåŠ¨å¼•æ“é€‰æ‹©
- âœ… æ•æ„Ÿå­—æ®µè¿‡æ»¤

### 4. ä¿®å¤å¼•æ“æµ‹è¯•
- âœ… DataXä½œä¸šç”Ÿæˆ
- âœ… Reader/Writeré…ç½®
- âœ… ä¿®å¤é˜ˆå€¼æ£€æŸ¥
- âœ… å¼‚å¸¸å¤„ç†

### 5. é€šçŸ¥æ¨¡å—æµ‹è¯•
- âœ… ä¼ä¸šå¾®ä¿¡å‘Šè­¦
- âœ… é˜ˆå€¼åˆ¤æ–­
- âœ… ç½‘ç»œå¼‚å¸¸å¤„ç†

### 6. ä¸»æµç¨‹æµ‹è¯•
- âœ… ç«¯åˆ°ç«¯å·¥ä½œæµ
- âœ… å¹¶å‘ä»»åŠ¡å¤„ç†
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—

### 7. å·¥å…·ç±»æµ‹è¯•
- âœ… åŠ å¯†è§£å¯†
- âœ… æ•°æ®åº“å·¥å…·
- âœ… é‡è¯•æœºåˆ¶
- âœ… æŠ¥å‘Šç”Ÿæˆ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–
```bash
pip install pytest pytest-mock pytest-cov
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
# æ–¹å¼1: ä½¿ç”¨æµ‹è¯•è„šæœ¬
python run_tests.py

# æ–¹å¼2: ç›´æ¥ä½¿ç”¨pytest
pytest tests/ -v --cov=core --cov=utils --cov-report=html

# æ–¹å¼3: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/ --cov=core --cov=utils --cov-report=html:htmlcov --cov-report=xml
```

### è¿è¡Œç‰¹å®šæµ‹è¯•
```bash
# è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶
pytest tests/test_config_manager.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
pytest tests/test_db_adapter.py::TestMySQLAdapter -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
pytest tests/test_compare_engine.py::TestPandasCompareEngine::test_compare_with_differences -v
```

## ğŸ“Š å½“å‰æµ‹è¯•çŠ¶æ€

### é€šè¿‡çš„æµ‹è¯• (115ä¸ª)
- âœ… test_config_manager.py: æ‰€æœ‰21ä¸ªæµ‹è¯•é€šè¿‡
- âœ… test_main.py: å¤§éƒ¨åˆ†æµ‹è¯•é€šè¿‡
- âœ… test_utils.py: æ ¸å¿ƒå·¥å…·ç±»æµ‹è¯•é€šè¿‡
- âœ… test_notification.py: å¤§éƒ¨åˆ†æµ‹è¯•é€šè¿‡

### éœ€è¦ä¿®å¤çš„æµ‹è¯• (75ä¸ª)
ä¸»è¦é—®é¢˜:
1. **Mockè·¯å¾„é”™è¯¯** (~30ä¸ª) - éœ€è¦ä¿®æ­£Mockçš„æ¨¡å—è·¯å¾„
2. **ç¼ºå°‘ä¾èµ–** (~15ä¸ª) - éœ€è¦Mock pysparkç­‰å¤–éƒ¨ä¾èµ–
3. **æ•°æ®ç±»å‹é—®é¢˜** (~10ä¸ª) - MySQLæŸ¥è¯¢ç»“æœéœ€è¦è½¬æ¢ä¸ºå­—å…¸
4. **AESå¯†é’¥é•¿åº¦** (~6ä¸ª) - æµ‹è¯•å¯†é’¥é•¿åº¦ä¸æ­£ç¡®
5. **ç¼ºå°‘å®ç°** (~5ä¸ª) - éƒ¨åˆ†å·¥å…·å‡½æ•°æœªå®ç°

## ğŸ”§ å·²çŸ¥é—®é¢˜å’Œä¿®å¤æ–¹æ¡ˆ

### é—®é¢˜1: MySQLé€‚é…å™¨æŸ¥è¯¢ç»“æœç±»å‹
**ä½ç½®**: `core/db_adapter/mysql_adapter.py:79,87`
**é—®é¢˜**: è¿”å›å…ƒç»„è€Œä¸æ˜¯å­—å…¸
**ä¿®å¤**:
```python
def query(self, sql: str, params: Tuple = None) -> List[Dict]:
    self.cursor.execute(sql, params)
    columns = [desc[0] for desc in self.cursor.description]
    rows = self.cursor.fetchall()
    return [dict(zip(columns, row)) for row in rows]  # è½¬æ¢ä¸ºå­—å…¸
```

### é—®é¢˜2: Mockè·¯å¾„é”™è¯¯
**é—®é¢˜**: Mockè·¯å¾„ä¸å®é™…å¯¼å…¥è·¯å¾„ä¸ä¸€è‡´
**ä¿®å¤**: æ£€æŸ¥importè¯­å¥,ä½¿ç”¨æ­£ç¡®çš„æ¨¡å—è·¯å¾„
```python
# æ­£ç¡®ç¤ºä¾‹
with patch('core.db_adapter.base_adapter.get_db_adapter') as mock:
    ...
```

### é—®é¢˜3: AESå¯†é’¥é•¿åº¦
**é—®é¢˜**: æµ‹è¯•å¯†é’¥"your-16-byte-key-1234"æ˜¯21å­—èŠ‚
**ä¿®å¤**: ä½¿ç”¨16/24/32å­—èŠ‚çš„å¯†é’¥
```python
with patch('config.settings.ENCRYPT_KEY', 'your-16-byte-key-12'):  # 16å­—èŠ‚
```

## ğŸ“ˆ è¦†ç›–ç‡è¯¦æƒ…

### é«˜è¦†ç›–ç‡æ¨¡å— (>80%)
| æ¨¡å— | è¦†ç›–ç‡ | çŠ¶æ€ |
|------|--------|------|
| core/config_manager.py | 90% | âœ… ä¼˜ç§€ |
| core/db_adapter/mysql_adapter.py | 98% | âœ… ä¼˜ç§€ |
| core/notification.py | 100% | âœ… å®Œç¾ |
| core/repair_engine/datax_repair.py | 85% | âœ… ä¼˜ç§€ |
| utils/crypto_utils.py | 83% | âœ… ä¼˜ç§€ |
| utils/db_utils.py | 100% | âœ… å®Œç¾ |
| utils/retry_utils.py | 100% | âœ… å®Œç¾ |

### ä½è¦†ç›–ç‡æ¨¡å— (<50%)
| æ¨¡å— | è¦†ç›–ç‡ | åŸå›  |
|------|--------|------|
| core/compare_engine/spark_engine.py | 4% | ç¼ºå°‘pysparkä¾èµ– |
| core/db_adapter/oracle_adapter.py | 1% | ç¼ºå°‘cx_Oracleä¾èµ– |
| core/monitor.py | 0% | æœªå®ç°æµ‹è¯• |
| utils/logger.py | 0% | æœªå®ç°æµ‹è¯• |

## ğŸ“ æµ‹è¯•æœ€ä½³å®è·µ

1. **ä½¿ç”¨å¤¹å…·å…±äº«æ•°æ®** - é€šè¿‡conftest.pyå®šä¹‰å…¬å…±æµ‹è¯•æ•°æ®
2. **Mockå¤–éƒ¨ä¾èµ–** - æ•°æ®åº“ã€ç½‘ç»œç­‰ä½¿ç”¨Mocké¿å…ç¯å¢ƒä¾èµ–
3. **æµ‹è¯•è¾¹ç•Œæ¡ä»¶** - ä¸ä»…æµ‹è¯•æ­£å¸¸æµç¨‹,è¿˜è¦æµ‹è¯•å¼‚å¸¸æƒ…å†µ
4. **æ¸…æ™°çš„æµ‹è¯•å‘½å** - æµ‹è¯•åæ¸…æ¥šè¯´æ˜æµ‹è¯•å†…å®¹
5. **ç‹¬ç«‹çš„æµ‹è¯•** - æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹,ä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„æ‰§è¡Œé¡ºåº

## ğŸ“ åç»­æ”¹è¿›è®¡åˆ’

### çŸ­æœŸ (ç«‹å³)
- [ ] ä¿®å¤Mockè·¯å¾„é”™è¯¯
- [ ] Mockå¤–éƒ¨ä¾èµ–(pyspark, cx_Oracleç­‰)
- [ ] ä¿®å¤MySQLé€‚é…å™¨è¿”å›ç±»å‹
- [ ] ä¿®å¤AESå¯†é’¥é•¿åº¦é—®é¢˜

### ä¸­æœŸ (1å‘¨å†…)
- [ ] å®ç°ç¼ºå¤±çš„data_type_utilså‡½æ•°
- [ ] å¢åŠ Sparkå¼•æ“æµ‹è¯•è¦†ç›–ç‡
- [ ] å¢åŠ Oracle/PostgreSQL/SQLServeré€‚é…å™¨æµ‹è¯•
- [ ] æå‡æ•´ä½“è¦†ç›–ç‡åˆ°90%+

### é•¿æœŸ (æŒç»­)
- [ ] é›†æˆåˆ°CI/CDæµç¨‹
- [ ] æ·»åŠ æ€§èƒ½æµ‹è¯•
- [ ] æ·»åŠ ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
- [ ] å®šæœŸç»´æŠ¤å’Œæ›´æ–°æµ‹è¯•ç”¨ä¾‹

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤æ‰€æœ‰é—®é¢˜å:
- âœ… **æµ‹è¯•é€šè¿‡ç‡**: >95% (180+/191)
- âœ… **æ ¸å¿ƒé€»è¾‘è¦†ç›–ç‡**: >95%
- âœ… **æ€»ä½“è¦†ç›–ç‡**: >85%
- âœ… **æµ‹è¯•æ‰§è¡Œæ—¶é—´**: <30ç§’

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜,è¯·å‚è€ƒ:
1. `tests/README.md` - æµ‹è¯•ä½¿ç”¨è¯´æ˜
2. `tests/TEST_FIX_REPORT.md` - è¯¦ç»†é—®é¢˜ä¿®å¤æŒ‡å—
3. é¡¹ç›®æ–‡æ¡£ - `README.md`

## ğŸ† æ€»ç»“

âœ… **å·²å®Œæˆ**:
- åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•æ¡†æ¶ (191ä¸ªæµ‹è¯•ç”¨ä¾‹)
- è¦†ç›–æ‰€æœ‰æ ¸å¿ƒæ¨¡å—å’ŒåŠŸèƒ½
- æä¾›è¯¦ç»†çš„æµ‹è¯•æ–‡æ¡£å’Œä¿®å¤æŒ‡å—
- é…ç½®äº†pytestå’Œè¦†ç›–ç‡æŠ¥å‘Š
- é€šè¿‡äº†115ä¸ªæµ‹è¯• (60%é€šè¿‡ç‡)

ğŸ”§ **å¾…ä¿®å¤**:
- 75ä¸ªæµ‹è¯•éœ€è¦å°ä¿®æ”¹ (ä¸»è¦æ˜¯Mocké…ç½®)
- é¢„è®¡ä¿®å¤æ—¶é—´: 2-4å°æ—¶
- ä¿®å¤åå¯è¾¾95%+é€šè¿‡ç‡

ğŸ¯ **æ ¸å¿ƒä»·å€¼**:
- ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œå¯é æ€§
- å¿«é€Ÿå‘ç°å›å½’é—®é¢˜
- ä¾¿äºä»£ç é‡æ„å’Œç»´æŠ¤
- æä¾›æ´»æ–‡æ¡£å’Œç¤ºä¾‹

---

**æµ‹è¯•å¥—ä»¶åˆ›å»ºå®Œæˆ! ğŸ‰**

è¿è¡Œ `python run_tests.py` å¼€å§‹æµ‹è¯•,æˆ–æŸ¥çœ‹ `htmlcov/index.html` æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Šã€‚
